<!DOCTYPE html>
<html>
<head>
    <title>Collaborative Editor</title>
    <style>
        textarea { width: 100%; height: 300px; }
    </style>
</head>
<body>
    <h1>Collaborative Text Editor</h1>

    <p id="serverInfo">Detecting server LAN IP...</p>

    <textarea id="editor"></textarea>
    
    <script>
        const editor = document.getElementById("editor");
        let isRemoteUpdate = false;

        // Automatically use the same host as the webpage
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;  // <-- MAGIC FIX
        const ws = new WebSocket(`${protocol}//${host}/ws`);

        ws.onopen = () => {
            console.log("WebSocket connected");

            editor.addEventListener("input", () => {
                if (!isRemoteUpdate && ws.readyState === WebSocket.OPEN) {
                    ws.send(editor.value);
                }
            });
        };

        ws.onmessage = (event) => {
            isRemoteUpdate = true;
            editor.value = event.data;
            isRemoteUpdate = false;
        };
    </script>

    <script>
        fetch("/server-info")
        .then(res => res.json())
        .then(data => {
            document.getElementById("serverInfo").textContent =
                "Server connected at: " + data.lan_ip + ":" + data.port;
        })
        .catch(() => {
            document.getElementById("serverInfo").textContent =
                "Unable to detect server LAN IP";
        });
    </script>

</body>
</html>
